name: CI - Build and Test

# Trigger the workflow on push and pull request events
on: [push, pull_request]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python
      - name: Set up Python
        if: github.ref == 'refs/heads/main'
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      # Step 3: Install dependencies
      - name: Install dependencies
        if: github.ref == 'refs/heads/main'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      # Step 4: Run pytest
      - name: Run tests
        if: github.ref == 'refs/heads/main'
        run: |
          pytest --maxfail=1 --disable-warnings -q

      # Step 5: Run Semgrep ‚Äî branch-specific rulesets
      - name: Run Semgrep rulesets
        run: |
          set -e
          
          # install semgrep and jq
          python -m pip install --upgrade pip
          python -m pip install semgrep
          sudo apt-get update -y
          sudo apt-get install -y jq

          # Determine rulesets and scan path based on branch
          if [ "${{ github.ref }}" == "refs/heads/test/juice-shop-pipeline" ]; then
            echo "üîç Running Semgrep for JavaScript/Node.js (Juice Shop)"
            RULESETS="p/owasp-top-ten p/javascript p/typescript p/nodejs"
            SCAN_PATH="juice-shop"
          else
            echo "üîç Running Semgrep for Python (Flask app)"
            RULESETS="p/owasp-top-ten p/python"
            SCAN_PATH="."
          fi

          # Verify directory exists
          if [ ! -d "$SCAN_PATH" ]; then
            echo "‚ùå Error: Scan path '$SCAN_PATH' does not exist"
            ls -la
            exit 1
          fi

          # run semgrep with branch-specific rulesets, output JSON
          echo "Running Semgrep with rulesets: $RULESETS on path: $SCAN_PATH"
          semgrep --config $RULESETS --json -o semgrep-report.json $SCAN_PATH

          # count ERROR severity findings and fail if any
          ERR_COUNT=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-report.json)
          TOTAL_COUNT=$(jq '[.results[]] | length' semgrep-report.json)
          echo "üìä Semgrep Results: $TOTAL_COUNT total findings, $ERR_COUNT ERROR severity"
          
          if [ "$ERR_COUNT" -gt 0 ]; then
            echo "‚ùå Failing CI due to Semgrep ERROR findings"
            jq '.results[] | select(.extra.severity == "ERROR")' semgrep-report.json
            exit 1
          fi
        continue-on-error: ${{ github.ref == 'refs/heads/test/juice-shop-pipeline' }}

      # Step 6: Verify workspace and prepare for SonarQube
      - name: Verify workspace structure
        run: |
          echo "üìã Workspace structure:"
          echo "Current directory: $(pwd)"
          echo "Branch: ${{ github.ref }}"
          ls -la
          
          if [ "${{ github.ref }}" == "refs/heads/test/juice-shop-pipeline" ]; then
            if [ -d "juice-shop" ]; then
              echo "‚úÖ juice-shop directory found"
              echo "juice-shop contents:"
              ls -la juice-shop/ | head -20
            else
              echo "‚ùå juice-shop directory NOT found!"
              exit 1
            fi
          fi

      # Step 7: Run SonarQube Analysis (branch-specific)
      - name: Run SonarQube analysis
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602 # v6.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=hs-fassih
            ${{ github.ref == 'refs/heads/test/juice-shop-pipeline' && '-Dsonar.sources=juice-shop -Dsonar.language=js -Dsonar.javascript.node.maxspace=4096 -Dsonar.exclusions=**/node_modules/**,**/build/**,**/dist/**,**/coverage/**,**/test/**' || '-Dsonar.sources=. -Dsonar.language=py -Dsonar.python.version=3.13 -Dsonar.exclusions=tests/**,**/__pycache__/**,**/*.pyc,.pytest_cache/**,instance/**,node_modules/**,juice-shop/**' }}

      # Step 8: Check SonarQube Quality Gate (HIGH and CRITICAL only)
      - name: Check SonarQube Quality Gate
        run: |
          set -e
          
          # Install jq for JSON parsing
          sudo apt-get install -y jq

          # Wait for SonarQube analysis to complete
          echo "‚è≥ Waiting for SonarQube analysis to complete..."
          for i in {1..30}; do
            TASK_STATUS=$(curl -s -H "Authorization: Bearer ${{ secrets.SONAR_TOKEN }}" \
              "https://sonarcloud.io/api/ce/activity?projectKey=${{ secrets.SONAR_PROJECT_KEY }}" | jq -r '.tasks[0].status // "PENDING"')
            
            if [ "$TASK_STATUS" = "SUCCESS" ]; then
              echo "‚úÖ SonarQube analysis completed successfully"
              break
            elif [ "$TASK_STATUS" = "FAILED" ]; then
              echo "‚ùå SonarQube analysis failed"
              exit 1
            fi
            
            if [ $i -lt 30 ]; then
              echo "‚è≥ Waiting for analysis... (attempt $i/30) - Status: $TASK_STATUS"
              sleep 10
            else
              echo "‚ùå Timeout waiting for SonarQube analysis"
              exit 1
            fi
          done

          # Get quality gate status
          QUALITY_GATE=$(curl -s -H "Authorization: Bearer ${{ secrets.SONAR_TOKEN }}" \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=${{ secrets.SONAR_PROJECT_KEY }}" | jq -r '.projectStatus.status // "NONE"')

          # Get issues by severity with proper null handling
          CRITICAL_ISSUES=$(curl -s -H "Authorization: Bearer ${{ secrets.SONAR_TOKEN }}" \
            "https://sonarcloud.io/api/issues/search?componentKeys=${{ secrets.SONAR_PROJECT_KEY }}&severities=CRITICAL&resolved=false" | jq '.total // 0')
          
          HIGH_ISSUES=$(curl -s -H "Authorization: Bearer ${{ secrets.SONAR_TOKEN }}" \
            "https://sonarcloud.io/api/issues/search?componentKeys=${{ secrets.SONAR_PROJECT_KEY }}&severities=HIGH&resolved=false" | jq '.total // 0')

          echo "üìä SonarQube Quality Gate Results:"
          echo "   Quality Gate Status: $QUALITY_GATE"
          echo "   Critical Issues: $CRITICAL_ISSUES"
          echo "   High Issues: $HIGH_ISSUES"

          # Validate we got actual numbers
          if ! [[ "$CRITICAL_ISSUES" =~ ^[0-9]+$ ]] || ! [[ "$HIGH_ISSUES" =~ ^[0-9]+$ ]]; then
            echo "‚ö†Ô∏è  Warning: Failed to get valid issue counts from SonarQube API"
            echo "   CRITICAL_ISSUES: $CRITICAL_ISSUES"
            echo "   HIGH_ISSUES: $HIGH_ISSUES"
            exit 1
          fi

          # Fail only if there are HIGH or CRITICAL severity issues
          if [ "$CRITICAL_ISSUES" -gt 0 ] || [ "$HIGH_ISSUES" -gt 0 ]; then
            echo "‚ùå Failing CI: Found $CRITICAL_ISSUES CRITICAL and $HIGH_ISSUES HIGH severity issues"
            exit 1
          else
            echo "‚úÖ Quality Gate passed: No HIGH or CRITICAL severity issues found"
          fi
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: ${{ github.ref == 'refs/heads/test/juice-shop-pipeline' }}